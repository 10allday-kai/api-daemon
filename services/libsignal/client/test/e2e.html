<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LibSignal Tests</title>

    <link rel="stylesheet" href="http://127.0.0.1:8081/tests/testing.css" />
  </head>

  <body>
    <script src="http://127.0.0.1:8081/api/v1/shared/core.js"></script>
    <script src="http://127.0.0.1:8081/api/v1/shared/session.js"></script>
    <script src="http://127.0.0.1:8081/api/v1/libsignal/service.js"></script>
    <script src="http://127.0.0.1:8081/tests/testing.js"></script>
    <script src="data.js"></script>
    <script src="store.js"></script>

    <script>
      async function createUser(tester, address) {
        let context;
        let deviceId = address.deviceId;
        await tester.assert_eq(
          `getContext for user ${address.name} (${address.deviceId})`,
          (service) => (context = service.newGlobalContext()),
          true,
          (result) => {
            context = result;
            return !!result;
          }
        );

        let registrationId = await context.generateRegistrationId();
        let preKeys = await context.generatePreKeys(1, 100);
        let preKey = preKeys[0];
        let identityKey = await context.generateIdentityKeyPair();
        let signedPreKey = await context.generateSignedPreKey(
          identityKey,
          1,
          Date.now()
        );

        let preKeyBundle = {
          registrationId,
          deviceId,
          preKeyId: preKey.id,
          preKeyPublic: preKey.keyPair.publicKey,
          signedPreKeyId: signedPreKey.id,
          signedPreKeyPublic: signedPreKey.keyPair.publicKey,
          signedPreKeySignature: signedPreKey.signature,
          identityKey: identityKey.publicKey,
        };

        // Create a store context.
        let storeContext = createStoreContextFor(tester);
        storeContext.identityKeyStore.setKeyPair(identityKey);

        return {
            context,
            registrationId,
            preKeys,
            identityKey,
            signedPreKey,
            preKeyBundle,
            storeContext,
        }
      }

      async function run_tests() {
        let tester = await test_service(
          lib_libsignal.Signal,
          "test-client-signal"
        );

        let aliceAddress = {
          name: "Alice",
          deviceId: 42,
        };

        let alice = await createUser(tester, aliceAddress);
        let sessionBuilder = await alice.context.sessionBuilder(
          aliceAddress,
          alice.storeContext
        );
        console.log(`sessionBuilder is `, sessionBuilder);

        await tester.assert_eq(
          "Alice processPreKeyBundle",
          (service) => sessionBuilder.processPreKeyBundle(alice.preKeyBundle),
          {}
        );

        // Now create a session cipher and use it to encrypt.
        let decryptionCallback = new DecryptionCallbackWrapper(
          tester,
          (plaintext) => {
            console.log(`Decrypted: ${plaintext}`);
            return Promise.resolve();
          }
        );

        let sessionCipher = await alice.context.sessionCipher(
          aliceAddress,
          alice.storeContext,
          decryptionCallback
        );

        let reporter = new TestReporter([tester]);
        reporter.output();

        console.log(`Test run done!`);
      }

      run_tests();
    </script>
  </body>
</html>

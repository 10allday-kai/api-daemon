<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Apps Service Tests</title>
    <link rel="stylesheet" href="http://127.0.0.1:8081/tests/testing.css" />
  </head>

  <body>
    <script src="http://127.0.0.1:8081/api/v1/shared/core.js"></script>
    <script src="http://127.0.0.1:8081/api/v1/shared/session.js"></script>
    <script src="http://127.0.0.1:8081/api/v1/apps/service.js"></script>
    <script src="http://127.0.0.1:8081/tests/testing.js"></script>
    <script src="results.js"></script>

    <script>
      async function run_tests() {
        console.log(`Apps Test started!`);

        let tester = await test_service(lib_apps.AppsManager, "apps-client");

        let AppsServiceState = lib_apps.AppsServiceState;
        let AppsServiceError = lib_apps.AppsServiceError;

        await tester.assert_eq(
          "get state",
          service => service.getState(),
          AppsServiceState.RUNNING
        );

        function sort_result(a, b) {
          return a.name > b.name;
        }

        let provider = new TokenProvider(tester.service, tester.session);
        await tester.service.setTokenProvider(provider);
        
        // check_for_update
        let on_update_available = tester.setup_event(tester.service.APP_UPDATE_AVAILABLE_EVENT);

        await tester.assert_eq(
          "check for update",
          service => service.checkForUpdate("http://127.0.0.1:8596/apps/ciautotest/manifest.webmanifest", {autoInstall: true}),
          true
        );
        
        await tester.assert_event_eq("on update event", on_update_available, update_expected(lib_apps.AppsUpdateState.AVAILABLE, true));

        let update_manifest_cached = "http://cached.localhost:8081/ciautotest/update.webmanifest";
        let new_version = "0.2";
        await tester.assert_eq(
          "get cached app update manifest",
          service => {
            return new Promise((resolve, reject) => {
                let req = new XMLHttpRequest();
                req.open("GET", update_manifest_cached);
                req.responseType = "json";
                req.onload = function() {
                    if (req.status == 200 ) {
                        console.log(req.response);
                        resolve(req.response.version);
                    } else {
                        reject("error, status code: " + req.status);
                    }
                };
                req.send();
            });
          },
          new_version,
        );

        let on_updated_handler = tester.setup_event(tester.service.APP_UPDATED_EVENT);
        let on_updating_handler = tester.setup_event(tester.service.APP_UPDATING_EVENT);
        await tester.assert_eq(
          "update app",
          service => service.update("http://ciautotest.localhost:8081/manifest.webmanifest"),
          update_expected(0)
        );
        await tester.assert_event_eq("on updating event", on_updating_handler, update_expected(lib_apps.AppsUpdateState.UPDATING));
        on_updating_handler.stop();
        await tester.assert_event_eq("on update event", on_updated_handler, update_expected(lib_apps.AppsUpdateState.IDLE));
        on_updated_handler.stop();

        let manifest_url = "http://ciautotest.localhost:8081/manifest.webmanifest";
        await tester.assert_eq(
          "get new app manifest",
          service => {
            return new Promise((resolve, reject) => {
                let req = new XMLHttpRequest();
                req.open("GET", manifest_url);
                req.responseType = "json";
                req.onload = function() {
                    if (req.status == 200 ) {
                        console.log(req.response);
                        resolve(req.response.version);
                    } else {
                        reject("error, status code: " + req.status);
                    }
                };
                req.send();
            });
          },
          new_version,
        );
        
        // Check for update for pre-installed app
        let on_update_available_pre_installed = tester.setup_event(tester.service.APP_UPDATE_AVAILABLE_EVENT);

        await tester.assert_eq(
          "check for pre-installed update",
          service => service.checkForUpdate("http://127.0.0.1:8596/apps/calculator/manifest.webmanifest", {autoInstall: false}),
          true
        );
        
        await tester.assert_event_eq("on update event", on_update_available_pre_installed, update_expected_pre_installed(lib_apps.AppsUpdateState.AVAILABLE, false));

        let on_updated_pre_installed_handler = tester.setup_event(tester.service.APP_UPDATED_EVENT);
        let on_updating_pre_installed_handler = tester.setup_event(tester.service.APP_UPDATING_EVENT);
        
        let pre_installed_manifest_url = "http://calculator.localhost:8081/manifest.webmanifest";
        let pre_installed_new_version = "0.2";
        await tester.assert_eq(
          "get cached pre-load app update manifest",
          service => {
            return service.getApp(pre_installed_manifest_url).then(app => {
              if (!app.updateManifestUrl) {
                return Promise.reject("failed to get update manifest");
              }

              return new Promise((resolve, reject) => {
                let req = new XMLHttpRequest();
                // updateManifestUrl http://cached.localhost:8081/calculator/update.webmanifest
                req.open("GET", app.updateManifestUrl);
                req.responseType = "json";
                req.onload = function() {
                    if (req.status == "200" ) {
                        resolve(req.response.version);
                    } else {
                        reject("error, status code: " + req.status);
                    }
                };
                req.send();
              });
            });
          },
          pre_installed_new_version,
        );

        await tester.assert_eq(
          "update pre-installed app",
          service => service.update(pre_installed_manifest_url),
          update_expected_pre_installed(0)
        );
        await tester.assert_event_eq("on updating pre-installed event", on_updating_pre_installed_handler, update_expected_pre_installed(lib_apps.AppsUpdateState.UPDATING));
        on_updating_pre_installed_handler.stop();
        await tester.assert_event_eq("on update pre-installed event", on_updated_pre_installed_handler, update_expected_pre_installed(lib_apps.AppsUpdateState.IDLE));
        on_updated_pre_installed_handler.stop();

        await tester.assert_eq(
          "get pre-installed app manifest",
          service => {
            return new Promise((resolve, reject) => {
                let req = new XMLHttpRequest();
                req.open("GET", pre_installed_manifest_url);
                req.responseType = "json";
                req.onload = function() {
                    if (req.status == 200 ) {
                        console.log(req.response);
                        resolve(req.response.version);
                    } else {
                        reject("error, status code: " + req.status);
                    }
                };
                req.send();
            });
          },
          pre_installed_new_version,
        );

        // Test uninstall
        let on_uninstall1_handler = tester.setup_event(tester.service.APP_UNINSTALLED_EVENT);
        await tester.assert_eq(
          "uninstall app",
          service => service.uninstall("http://ciautotest.localhost:8081/manifest.webmanifest"),
          "http://ciautotest.localhost:8081/manifest.webmanifest"
        );
        await tester.assert_event_eq("on uninstall event", on_uninstall1_handler, "http://ciautotest.localhost:8081/manifest.webmanifest");
        on_uninstall1_handler.stop();

        await tester.assert_eq(
          "get all 3",
          service => {
            return new Promise((resolve, reject) => {
              service.getAll().then(
                observed => {
                  resolve(observed ? observed.sort(sort_result) : null);
                },
                err => {
                  reject(err);
                }
              );
            });
          },
          get_all_expected2.sort(sort_result)
        );

        let reporter = new TestReporter([tester]);
        reporter.output();

        console.log(`Test run done!`);
      }

      run_tests();
    </script>
  </body>
</html>
